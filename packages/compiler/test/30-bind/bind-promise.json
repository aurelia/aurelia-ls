[
  {
    "name": "PR-01 promise.bind with then branch: value in root; alias + inner binding in nested then overlay",
    "markup": "<div promise.bind=\"p\"><template then=\"r\"><span title.bind=\"a\"></span></template></div>",
    "expect": {
      "frames": [
        { "label": "root", "parent": null, "kind": "root", "overlay": null, "origin": null },
        { "label": "overlay:promiseValue@1", "parent": "root", "kind": "overlay", "overlay": null, "origin": "promiseValue" },
        { "label": "overlay:promiseBranch@2", "parent": "overlay:promiseValue@1", "kind": "overlay", "overlay": null, "origin": "promiseBranch" }
      ],
      "locals": [
        { "frame": "overlay:promiseBranch@2", "kind": "alias", "name": "r" }
      ],
      "exprs": [
        { "kind": "expr", "frame": "root", "code": "p" },
        { "kind": "expr", "frame": "overlay:promiseBranch@2", "code": "a" }
      ],
      "diags": []
    }
  },
  {
    "name": "PR-02 promise (value-less) with catch branch only; default alias in catch overlay",
    "markup": "<div promise><template catch><i>${e}</i></template></div>",
    "expect": {
      "frames": [
        { "label": "root", "parent": null, "kind": "root", "overlay": null, "origin": null },
        { "label": "overlay:promiseValue@1", "parent": "root", "kind": "overlay", "overlay": null, "origin": "promiseValue" },
        { "label": "overlay:promiseBranch@2", "parent": "overlay:promiseValue@1", "kind": "overlay", "overlay": null, "origin": "promiseBranch" }
      ],
      "locals": [
        { "frame": "overlay:promiseBranch@2", "kind": "alias", "name": "catch" }
      ],
      "exprs": [
        { "kind": "expr", "frame": "root", "code": "promise" },
        { "kind": "expr", "frame": "overlay:promiseBranch@2", "code": "e" }
      ],
      "diags": []
    }
  },
  {
    "name": "PR-03 promise with both then and catch branches - each in own overlay",
    "markup": "<div promise.bind=\"task\"><template then=\"val\"><b>${a}</b></template><template catch=\"err\"><i>${b}</i></template></div>",
    "expect": {
      "frames": [
        { "label": "root", "parent": null, "kind": "root", "overlay": null, "origin": null },
        { "label": "overlay:promiseValue@1", "parent": "root", "kind": "overlay", "overlay": null, "origin": "promiseValue" },
        { "label": "overlay:promiseBranch@2", "parent": "overlay:promiseValue@1", "kind": "overlay", "overlay": null, "origin": "promiseBranch" },
        { "label": "overlay:promiseBranch@3", "parent": "overlay:promiseValue@1", "kind": "overlay", "overlay": null, "origin": "promiseBranch" }
      ],
      "locals": [
        { "frame": "overlay:promiseBranch@2", "kind": "alias", "name": "val" },
        { "frame": "overlay:promiseBranch@3", "kind": "alias", "name": "err" }
      ],
      "exprs": [
        { "kind": "expr", "frame": "root", "code": "task" },
        { "kind": "expr", "frame": "overlay:promiseBranch@2", "code": "a" },
        { "kind": "expr", "frame": "overlay:promiseBranch@3", "code": "b" }
      ],
      "diags": []
    }
  },
  {
    "name": "PR-04 promise inside with",
    "markup": "<div with.bind=\"ctx\"><div promise.bind=\"p\"><template then><span>${x}</span></template></div></div>",
    "expect": {
      "frames": [
        { "label": "root", "parent": null, "kind": "root", "overlay": null, "origin": null },
        { "label": "overlay:valueOverlay@1", "parent": "root", "kind": "overlay", "overlay": "value", "origin": "valueOverlay" },
        { "label": "overlay:promiseValue@2", "parent": "overlay:valueOverlay@1", "kind": "overlay", "overlay": null, "origin": "promiseValue" },
        { "label": "overlay:promiseBranch@3", "parent": "overlay:promiseValue@2", "kind": "overlay", "overlay": null, "origin": "promiseBranch" }
      ],
      "locals": [
        { "frame": "overlay:promiseBranch@3", "kind": "alias", "name": "then" }
      ],
      "exprs": [
        { "kind": "expr", "frame": "root", "code": "ctx" },
        { "kind": "expr", "frame": "overlay:valueOverlay@1", "code": "p" },
        { "kind": "expr", "frame": "overlay:promiseBranch@3", "code": "x" }
      ],
      "diags": []
    }
  },
  {
    "name": "PR-05 promise branch contains with",
    "markup": "<div promise.bind=\"p\"><template then><section with.bind=\"w\"><i>${z}</i></section></template></div>",
    "expect": {
      "frames": [
        { "label": "root", "parent": null, "kind": "root", "overlay": null, "origin": null },
        { "label": "overlay:promiseValue@1", "parent": "root", "kind": "overlay", "overlay": null, "origin": "promiseValue" },
        { "label": "overlay:promiseBranch@2", "parent": "overlay:promiseValue@1", "kind": "overlay", "overlay": null, "origin": "promiseBranch" },
        { "label": "overlay:valueOverlay@3", "parent": "overlay:promiseBranch@2", "kind": "overlay", "overlay": "value", "origin": "valueOverlay" }
      ],
      "locals": [
        { "frame": "overlay:promiseBranch@2", "kind": "alias", "name": "then" }
      ],
      "exprs": [
        { "kind": "expr", "frame": "root", "code": "p" },
        { "kind": "expr", "frame": "overlay:promiseBranch@2", "code": "w" },
        { "kind": "expr", "frame": "overlay:valueOverlay@3", "code": "z" }
      ],
      "diags": []
    }
  },
  {
    "name": "PR-06 promise with pending branch only - pending uses promiseValue overlay directly",
    "comment": "pending branch doesn't create its own promiseBranch overlay - expressions eval in promiseValue",
    "markup": "<div promise.bind=\"p\"><template pending>Loading ${msg}...</template></div>",
    "expect": {
      "frames": [
        { "label": "root", "parent": null, "kind": "root", "overlay": null, "origin": null },
        { "label": "overlay:promiseValue@1", "parent": "root", "kind": "overlay", "overlay": null, "origin": "promiseValue" }
      ],
      "locals": [],
      "exprs": [
        { "kind": "expr", "frame": "root", "code": "p" },
        { "kind": "expr", "frame": "overlay:promiseValue@1", "code": "msg" }
      ],
      "diags": []
    }
  },
  {
    "name": "PR-07 promise inside repeat - iterator overlay wraps promise overlays",
    "markup": "<div repeat.for=\"item of items\"><div promise.bind=\"item.task\"><template then=\"data\">${data}</template></div></div>",
    "expect": {
      "frames": [
        { "label": "root", "parent": null, "kind": "root", "overlay": null, "origin": null },
        { "label": "overlay:iterator@1", "parent": "root", "kind": "overlay", "overlay": null, "origin": "iterator" },
        { "label": "overlay:promiseValue@2", "parent": "overlay:iterator@1", "kind": "overlay", "overlay": null, "origin": "promiseValue" },
        { "label": "overlay:promiseBranch@3", "parent": "overlay:promiseValue@2", "kind": "overlay", "overlay": null, "origin": "promiseBranch" }
      ],
      "locals": [
        { "frame": "overlay:iterator@1", "kind": "iteratorLocal", "name": "item" },
        { "frame": "overlay:iterator@1", "kind": "contextual", "name": "$index" },
        { "frame": "overlay:iterator@1", "kind": "contextual", "name": "$first" },
        { "frame": "overlay:iterator@1", "kind": "contextual", "name": "$last" },
        { "frame": "overlay:iterator@1", "kind": "contextual", "name": "$even" },
        { "frame": "overlay:iterator@1", "kind": "contextual", "name": "$odd" },
        { "frame": "overlay:iterator@1", "kind": "contextual", "name": "$length" },
        { "frame": "overlay:iterator@1", "kind": "contextual", "name": "$middle" },
        { "frame": "overlay:iterator@1", "kind": "contextual", "name": "$previous" },
        { "frame": "overlay:promiseBranch@3", "kind": "alias", "name": "data" }
      ],
      "exprs": [
        { "kind": "forOfHeader", "frame": "root" },
        { "kind": "expr", "frame": "overlay:iterator@1", "code": "item.task" },
        { "kind": "expr", "frame": "overlay:promiseBranch@3", "code": "data" }
      ],
      "diags": []
    }
  },
  {
    "name": "PR-08 repeat inside promise then branch - iterator inside promise branch",
    "markup": "<div promise.bind=\"fetchItems\"><template then=\"items\"><ul repeat.for=\"item of items\"><li>${item}</li></ul></template></div>",
    "expect": {
      "frames": [
        { "label": "root", "parent": null, "kind": "root", "overlay": null, "origin": null },
        { "label": "overlay:promiseValue@1", "parent": "root", "kind": "overlay", "overlay": null, "origin": "promiseValue" },
        { "label": "overlay:promiseBranch@2", "parent": "overlay:promiseValue@1", "kind": "overlay", "overlay": null, "origin": "promiseBranch" },
        { "label": "overlay:iterator@3", "parent": "overlay:promiseBranch@2", "kind": "overlay", "overlay": null, "origin": "iterator" }
      ],
      "locals": [
        { "frame": "overlay:promiseBranch@2", "kind": "alias", "name": "items" },
        { "frame": "overlay:iterator@3", "kind": "iteratorLocal", "name": "item" },
        { "frame": "overlay:iterator@3", "kind": "contextual", "name": "$index" },
        { "frame": "overlay:iterator@3", "kind": "contextual", "name": "$first" },
        { "frame": "overlay:iterator@3", "kind": "contextual", "name": "$last" },
        { "frame": "overlay:iterator@3", "kind": "contextual", "name": "$even" },
        { "frame": "overlay:iterator@3", "kind": "contextual", "name": "$odd" },
        { "frame": "overlay:iterator@3", "kind": "contextual", "name": "$length" },
        { "frame": "overlay:iterator@3", "kind": "contextual", "name": "$middle" },
        { "frame": "overlay:iterator@3", "kind": "contextual", "name": "$previous" }
      ],
      "exprs": [
        { "kind": "expr", "frame": "root", "code": "fetchItems" },
        { "kind": "forOfHeader", "frame": "overlay:promiseBranch@2" },
        { "kind": "expr", "frame": "overlay:iterator@3", "code": "item" }
      ],
      "diags": []
    }
  },
  {
    "name": "PR-09 promise with all three branches - pending, then, catch",
    "comment": "pending doesn't create overlay, then and catch do",
    "markup": "<div promise.bind=\"task\"><template pending>${loadingMsg}</template><template then=\"data\">${data}</template><template catch=\"err\">${err}</template></div>",
    "expect": {
      "frames": [
        { "label": "root", "parent": null, "kind": "root", "overlay": null, "origin": null },
        { "label": "overlay:promiseValue@1", "parent": "root", "kind": "overlay", "overlay": null, "origin": "promiseValue" },
        { "label": "overlay:promiseBranch@2", "parent": "overlay:promiseValue@1", "kind": "overlay", "overlay": null, "origin": "promiseBranch" },
        { "label": "overlay:promiseBranch@3", "parent": "overlay:promiseValue@1", "kind": "overlay", "overlay": null, "origin": "promiseBranch" }
      ],
      "locals": [
        { "frame": "overlay:promiseBranch@2", "kind": "alias", "name": "data" },
        { "frame": "overlay:promiseBranch@3", "kind": "alias", "name": "err" }
      ],
      "exprs": [
        { "kind": "expr", "frame": "root", "code": "task" },
        { "kind": "expr", "frame": "overlay:promiseValue@1", "code": "loadingMsg" },
        { "kind": "expr", "frame": "overlay:promiseBranch@2", "code": "data" },
        { "kind": "expr", "frame": "overlay:promiseBranch@3", "code": "err" }
      ],
      "diags": []
    }
  },
  {
    "name": "PR-10 nested promise - promise inside promise then branch",
    "markup": "<div promise.bind=\"outer\"><template then=\"innerP\"><div promise.bind=\"innerP\"><template then=\"val\">${val}</template></div></template></div>",
    "expect": {
      "frames": [
        { "label": "root", "parent": null, "kind": "root", "overlay": null, "origin": null },
        { "label": "overlay:promiseValue@1", "parent": "root", "kind": "overlay", "overlay": null, "origin": "promiseValue" },
        { "label": "overlay:promiseBranch@2", "parent": "overlay:promiseValue@1", "kind": "overlay", "overlay": null, "origin": "promiseBranch" },
        { "label": "overlay:promiseValue@3", "parent": "overlay:promiseBranch@2", "kind": "overlay", "overlay": null, "origin": "promiseValue" },
        { "label": "overlay:promiseBranch@4", "parent": "overlay:promiseValue@3", "kind": "overlay", "overlay": null, "origin": "promiseBranch" }
      ],
      "locals": [
        { "frame": "overlay:promiseBranch@2", "kind": "alias", "name": "innerP" },
        { "frame": "overlay:promiseBranch@4", "kind": "alias", "name": "val" }
      ],
      "exprs": [
        { "kind": "expr", "frame": "root", "code": "outer" },
        { "kind": "expr", "frame": "overlay:promiseBranch@2", "code": "innerP" },
        { "kind": "expr", "frame": "overlay:promiseBranch@4", "code": "val" }
      ],
      "diags": []
    }
  }
]
